Homework 6
================
Jake Vettoretti
2025-11-29

``` r
library(broom)
library(tidyverse)
```

    ## ── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
    ## ✔ dplyr     1.1.4     ✔ readr     2.1.5
    ## ✔ forcats   1.0.0     ✔ stringr   1.5.1
    ## ✔ ggplot2   3.5.2     ✔ tibble    3.3.0
    ## ✔ lubridate 1.9.4     ✔ tidyr     1.3.1
    ## ✔ purrr     1.1.0     
    ## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
    ## ✖ dplyr::filter() masks stats::filter()
    ## ✖ dplyr::lag()    masks stats::lag()
    ## ℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors

``` r
library(forcats)
library(p8105.datasets)
```

## Problem 1

``` r
## Loading the data

homicides <- read_csv("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv")
```

    ## Rows: 52179 Columns: 12
    ## ── Column specification ────────────────────────────────────────────────────────
    ## Delimiter: ","
    ## chr (9): uid, victim_last, victim_first, victim_race, victim_age, victim_sex...
    ## dbl (3): reported_date, lat, lon
    ## 
    ## ℹ Use `spec()` to retrieve the full column specification for this data.
    ## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.

# Starting to clean and summarize

``` r
homicides_clean =
  homicides |>
    mutate(
      city_state = str_c(city, ", ", state),
      solved = if_else(disposition == "Closed by arrest", 1, 0),
      victim_age = as.numeric(victim_age)
      ) |>
    filter(
      !(city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL")),
      victim_race %in% c("White", "Black")
      )
```

    ## Warning: There was 1 warning in `mutate()`.
    ## ℹ In argument: `victim_age = as.numeric(victim_age)`.
    ## Caused by warning:
    ## ! NAs introduced by coercion

# GLM for Baltimore

``` r
# Filter to Baltimore
baltimore_data =
  homicides_clean |>
  filter(city_state == "Baltimore, MD")

# Fit logistic regression
baltimore_glm =
  glm(
    solved ~ victim_age + victim_sex + victim_race,
    data = baltimore_data,
    family = binomial
  )

# Tidy and extract adjusted OR for male vs female
baltimore_results =
  broom::tidy(
    baltimore_glm,
    exponentiate = TRUE,
    conf.int = TRUE
  ) |>
  filter(term == "victim_sexMale") |>
  select(term, estimate, conf.low, conf.high)

baltimore_results
```

    ## # A tibble: 1 × 4
    ##   term           estimate conf.low conf.high
    ##   <chr>             <dbl>    <dbl>     <dbl>
    ## 1 victim_sexMale    0.426    0.324     0.558

# GLM for each city

``` r
city_glm_results =
  homicides_clean |>
  group_by(city_state) |>
  nest() |>
  mutate(
    fit = map(
      data,
      ~ glm(
        solved ~ victim_age + victim_sex + victim_race,
        data = .x,
        family = binomial
      )
    ),
    tidy_fit = map(
      fit,
      ~ broom::tidy(
        .x,
        exponentiate = TRUE,
        conf.int = TRUE
      )
    )
  ) |>
  unnest(tidy_fit) |>
  filter(term == "victim_sexMale") |>
  select(city_state, term, estimate, conf.low, conf.high)
```

    ## Warning: There were 43 warnings in `mutate()`.
    ## The first warning was:
    ## ℹ In argument: `tidy_fit = map(fit, ~broom::tidy(.x, exponentiate = TRUE,
    ##   conf.int = TRUE))`.
    ## ℹ In group 1: `city_state = "Albuquerque, NM"`.
    ## Caused by warning:
    ## ! glm.fit: fitted probabilities numerically 0 or 1 occurred
    ## ℹ Run `dplyr::last_dplyr_warnings()` to see the 42 remaining warnings.

``` r
city_glm_results
```

    ## # A tibble: 47 × 5
    ## # Groups:   city_state [47]
    ##    city_state      term           estimate conf.low conf.high
    ##    <chr>           <chr>             <dbl>    <dbl>     <dbl>
    ##  1 Albuquerque, NM victim_sexMale    1.77     0.825     3.76 
    ##  2 Atlanta, GA     victim_sexMale    1.00     0.680     1.46 
    ##  3 Baltimore, MD   victim_sexMale    0.426    0.324     0.558
    ##  4 Baton Rouge, LA victim_sexMale    0.381    0.204     0.684
    ##  5 Birmingham, AL  victim_sexMale    0.870    0.571     1.31 
    ##  6 Boston, MA      victim_sexMale    0.674    0.353     1.28 
    ##  7 Buffalo, NY     victim_sexMale    0.521    0.288     0.936
    ##  8 Charlotte, NC   victim_sexMale    0.884    0.551     1.39 
    ##  9 Chicago, IL     victim_sexMale    0.410    0.336     0.501
    ## 10 Cincinnati, OH  victim_sexMale    0.400    0.231     0.667
    ## # ℹ 37 more rows

# Plot that shows the estimated ORs and CIs for each city

``` r
city_glm_results |>
  ggplot(aes(
    x = estimate,
    y = fct_reorder(city_state, estimate)
  )) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "gray50") +
  geom_point(size = 2) +
  geom_errorbar(aes(xmin = conf.low, xmax = conf.high), width = 0.2) +
  labs(
    title = "Adjusted Odds of a Homicide Being Solved (Male vs Female Victims)",
    subtitle = "Logistic regression for each city adjusted for age and race",
    x = "Adjusted Odds Ratio (Male vs Female)",
    y = NULL
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.y = element_text(size = 8)
  )
```

![](p8105_hw6_jpv2129_files/figure-gfm/unnamed-chunk-6-1.png)<!-- -->

Comments: Most cities show adjusted odds ratios close to one, which
means that after accounting for age and race the chance that a homicide
is solved is similar for male and female victims. A few cities have odds
ratios above one, suggesting higher odds of a solved case among male
victims, while others fall below one, suggesting higher odds among
female victims. Many cities also have wide confidence intervals, which
indicates substantial uncertainty and likely smaller sample sizes.
Overall, there is no clear or consistent pattern across cities, and most
results suggest little difference in solve rates by victim sex once
demographic factors are considered.
